NAME="netcdf-fortran"
INSTALL_NAME="netcdf-fortran"
MAJOR_VERSION="4"
MINOR_VERSION="5.4"
VERSION=${MAJOR_VERSION}.${MINOR_VERSION}

export LANG=C
export LC_ALL=C

cd ~/build
rm -fr ${NAME}-${VERSION}
tar xvf ${INSTALL_NAME}-${VERSION}.tar.gz
cd ${NAME}-${VERSION}

# NVIDIA HPC SDK
COMPILER="nvidia"

module purge
module load cmake/latest
module load nvidia
module load openmpi/4/nvidia/latest
module load nvhpc-nompi/latest
module load gcc/12/latest

mkdir ~/build/${NAME}-${VERSION}/build-${COMPILER}
cd ~/build/${NAME}-${VERSION}/build-${COMPILER}

export LD_LIBRARY_PATH=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia/lib:$LD_LIBRARY_PATH
LDFLAGS="-L/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia/lib"

cmake .. -DCMAKE_C_COMPILER=mpicc -DCMAKE_C_FLAGS="-tp zen2 -Mcache_align -fPIC" -DCMAKE_Fortran_COMPILER=mpifort -DCMAKE_Fortran_FLAGS="-tp zen2 -Mcache_align -fPIC" -DnetCDF_DIR=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia -DNETCDF_C_LIBRARY=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia/lib/libnetcdf.so -DNETCDF_C_INCLUDE_DIR=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia/include -DHAVE_SZIP_WRITE=ON -DHAVE_PARALLEL=ON -DCMAKE_INSTALL_PREFIX=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia -DCMAKE_INSTALL_LIBDIR=lib

make -j 48 install || exit

cd ~/build
rm -fr ${NAME}-${VERSION}

