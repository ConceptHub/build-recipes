NAME="hdf5"
INSTALL_NAME="hdf5"
MAJOR_VERSION="1"
MINOR_VERSION="12.2"
VERSION=${MAJOR_VERSION}.${MINOR_VERSION}

export LANG=C
export LC_ALL=C

cd ~/build
rm -fr ${NAME}-${VERSION}
tar xvf ${INSTALL_NAME}-${VERSION}.tar.bz2
cd ${NAME}-${VERSION}

# NVIDIA HPC SDK
COMPILER="nvidia"

module purge
module load cmake/latest
module load nvidia
module load openmpi/4/nvidia/latest
module load nvhpc-nompi/latest
module load gcc/12/latest

mkdir ~/build/${NAME}-${VERSION}/build-${COMPILER}
cd ~/build/${NAME}-${VERSION}/build-${COMPILER}

cmake .. -DHDF5_ENABLE_PARALLEL=ON -DLARGE_PARALLEL_IO=ON -DHDF5_BUILD_FORTRAN=ON -DHDF5_ENABLE_Z_LIB_SUPPORT=ON -DHDF5_ENABLE_SZIP_SUPPORT=ON -DHDF5_ENABLE_SZIP_ENCODING=ON -DSZIP_LIBRARY=/opt/software/libaec/1/1.0.6-nvidia/lib64/libsz.a -DSZIP_INCLUDE_DIR=/opt/software/libaec/1/1.0.6-nvidia/include -DHDF5_ENABLE_Z_LIB_SUPPORT=ON -DZLIB_INCLUDE_DIR=/opt/software/zlib/1/1.2.11-nvidia -DZLIB_LIBRARY_RELEASE=/opt/software/zlib/1/1.2.11-nvidia/lib/libz.a -DCMAKE_C_COMPILER=nvc -DCMAKE_C_FLAGS="-tp zen2 -Mcache_align ${CFLAGS}" -DCMAKE_CXX_COMPILER=nvc++ -DCMAKE_CXX_FLAGS="-tp zen2 -Mcache_align ${CXXFLAGS}" -DCMAKE_Fortran_COMPILER=nvfortran -DCMAKE_Fortran_FLAGS="-tp zen2 -Mcache_align ${FCFLAGS}" -DMPI_C_COMPILER=mpicc -DCMAKE_INSTALL_PREFIX=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia

make -j 48 install || exit

cd /opt/software/bundles/wrf/4-hdf5-netcdf-nvidia/lib

ln -s libhdf5_hl.so libhdf5_hl-shared.so
ln -s libhdf5.so libhdf5-shared.so

cd ~/build
rm -fr ${NAME}-${VERSION}

