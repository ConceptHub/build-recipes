NAME="netcdf-c"
INSTALL_NAME="netcdf-c"
MAJOR_VERSION="4"
MINOR_VERSION="9.0"
VERSION=${MAJOR_VERSION}.${MINOR_VERSION}

export LANG=C
export LC_ALL=C

cd ~/build
rm -fr ${NAME}-${VERSION}
tar xvf ${INSTALL_NAME}-${VERSION}.tar.gz
cd ${NAME}-${VERSION}

# NVIDIA HPC SDK
COMPILER="nvidia"

module purge
module load cmake/latest
module load nvidia
module load openmpi/4/nvidia/latest
module load nvhpc-nompi/latest
module load gcc/12/latest

mkdir ~/build/${NAME}-${VERSION}/build-${COMPILER}
cd ~/build/${NAME}-${VERSION}/build-${COMPILER}

cmake .. -DCMAKE_C_COMPILER=mpicc -DCMAKE_C_FLAGS="-tp zen2 -Mcache_align -fPIC ${CFLAGS}" -DCMAKE_CXX_COMPILER=mpicxx -DCMAKE_CXX_FLAGS="-tp zen2 -Mcache_align -fPIC ${CFLAGS}" -DHDF5_DIR=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia -DSzip_INCLUDE_DIRS=/opt/software/libaec/1/1.0.6-nvidia/include -DSzip_RELEASE_LIBRARY=/opt/software/libaec/1/1.0.6-nvidia/lib64/libsz.a -DZLIB_INCLUDE_DIR=/opt/software/zlib/1/1.2.11-nvidia -DZLIB_LIBRARY=/opt/software/zlib/1/1.2.11-nvidia/lib/libz.a -DCMAKE_INSTALL_PREFIX=/opt/software/bundles/wrf/4-hdf5-netcdf-nvidia -DCMAKE_INSTALL_LIBDIR=lib

make -j 48 install || exit

cd ~/build
rm -fr ${NAME}-${VERSION}
