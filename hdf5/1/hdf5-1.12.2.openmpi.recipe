NAME="hdf"
EPOCH=5
VERSION="1.12.2"
TAR_VERSION_STRING="1_12_2"

ZLIB_MODULE_NAME="zlib"
ZLIB_MAJOR_VERSION="1"
ZLIB_MINOR_VERSION="2.11"

LIBAEC_MODULE_NAME="libaec"
LIBAEC_MAJOR_VERSION="1"
LIBAEC_MINOR_VERSION="0.6"

ZLIB_VERSION=${ZLIB_MAJOR_VERSION}.${ZLIB_MINOR_VERSION}
LIBAEC_VERSION=${LIBAEC_MAJOR_VERSION}.${LIBAEC_MINOR_VERSION}

BUILD_ROOT=~/build

cd ${BUILD_ROOT}
rm -fr ${NAME}${EPOCH}-${NAME}${EPOCH}-${TAR_VERSION_STRING}
tar xvf ${NAME}${EPOCH}-${TAR_VERSION_STRING}.tar.gz
cd ${NAME}${EPOCH}-${NAME}${EPOCH}-${TAR_VERSION_STRING}

export LANG=C
export LC_ALL=C


# Intel oneAPI / OpenMPI

COMPILER="intel"
MPI="openmpi"

module purge
module load intel
module load compiler/latest
module load openmpi/4/intel/latest
module load ${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}
module load ${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}
module load gcc/12/latest

cmake -B build-${COMPILER} -DCMAKE_C_COMPILER=mpicc -DCMAKE_CXX_COMPILER=mpicxx -DCMAKE_Fortran_COMPILER=mpifort \
                           -DCMAKE_VERBOSE_MAKEFILE=OFF \
                           -DBUILD_TESTING=OFF \
                           -DCMAKE_C_FLAGS="-ip -static-intel -march=core-avx2 -fma -fPIC" \
                           -DCMAKE_CXX_FLAGS="-ip -static-intel -march=core-avx2 -fma -fPIC" \
                           -DCMAKE_Fortran_FLAGS="-ip -static-intel -march=core-avx2 -fma -fPIC" \
                           -DHDF5_ENABLE_PARALLEL=YES \
                           -DLARGE_PARALLEL_IO=YES \
                           -DHDF5_ENABLE_SZIP_SUPPORT=ON \
                           -DHDF5_ENABLE_SZIP_ENCODING=ON \
                           -DUSE_LIBAEC=ON \
                           -Dlibaec_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -Dlibaec_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/incude \
                           -DHDF5_ENABLE_Z_LIB_SUPPORT=ON \
                           -DZLIB_INCLUDE_DIR=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/include \
                           -DZLIB_LIBRARY_RELEASE=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/lib/libz.so \
                           -DSZIP_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -DSZIP_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/include \
                           -DCMAKE_BUILD_TYPE=Release \
                           -DCMAKE_INSTALL_PREFIX=/opt/software/${NAME}/${EPOCH}/${VERSION}-${COMPILER}-${MPI}
cmake --build build-${COMPILER} -j 48
cmake --install build-${COMPILER}


# NVIDIA HPC SDK / OpenMPI
COMPILER="nvidia"
MPI="openmpi"

module purge
module load openmpi/4/nvidia/latest
module load ${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}
module load ${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}
module load gcc/12/latest

cmake -B build-${COMPILER} -DCMAKE_C_COMPILER=mpicc -DCMAKE_CXX_COMPILER=mpicxx -DCMAKE_Fortran_COMPILER=mpifort \
                           -DCMAKE_VERBOSE_MAKEFILE=OFF \
                           -DBUILD_TESTING=OFF \
                           -DCMAKE_C_FLAGS="-tp=zen2 -Mcache_align -fast -Mvect -mavx2 -fPIC" \
                           -DCMAKE_CXX_FLAGS="-tp=zen2 -Mcache_align -fast -Mvect -mavx2 -fPIC" \
                           -DCMAKE_Fortran_FLAGS="-tp=zen2 -Mcache_align -fast -Mvect -mavx2 -fPIC" \
                           -DHDF5_ENABLE_PARALLEL=YES \
                           -DLARGE_PARALLEL_IO=YES \
                           -DHDF5_ENABLE_SZIP_SUPPORT=ON \
                           -DHDF5_ENABLE_SZIP_ENCODING=ON \
                           -DHDF5_ENABLE_Z_LIB_SUPPORT=ON \
                           -DUSE_LIBAEC=ON \
                           -Dlibaec_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -Dlibaec_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/incude \
                           -DZLIB_INCLUDE_DIR=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/include \
                           -DZLIB_LIBRARY_RELEASE=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/lib/libz.so \
                           -DSZIP_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -DSZIP_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/include \
                           -DCMAKE_BUILD_TYPE=Release \
                           -DCMAKE_INSTALL_PREFIX=/opt/software/${NAME}/${EPOCH}/${VERSION}-${COMPILER}-${MPI}

cmake --build build-${COMPILER} -j 48
cmake --install build-${COMPILER}


# AMD AOCC / OpenMPI
COMPILER="aocc"
MPI="openmpi"

module purge
module load openmpi/4/aocc/latest
module load ${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}
module load ${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}

cmake -B build-${COMPILER} -DCMAKE_C_COMPILER=mpicc -DCMAKE_CXX_COMPILER=mpicxx -DCMAKE_Fortran_COMPILER=mpifort \
                           -DCMAKE_VERBOSE_MAKEFILE=OFF \
                           -DBUILD_TESTING=OFF \
                           -DCMAKE_C_FLAGS="-mtune=native -mavx2 -mfma -fPIC" \
                           -DCMAKE_CXX_FLAGS="-mtune=native -mavx2 -mfma -fPIC" \
                           -DCMAKE_Fortran_FLAGS="-mtune=native -mavx2 -mfma -fPIC" \
                           -DHDF5_ENABLE_PARALLEL=YES \
                           -DLARGE_PARALLEL_IO=YES \
                           -DHDF5_ENABLE_SZIP_SUPPORT=ON \
                           -DHDF5_ENABLE_SZIP_ENCODING=ON \
                           -DHDF5_ENABLE_Z_LIB_SUPPORT=ON \
                           -DUSE_LIBAEC=ON \
                           -Dlibaec_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -Dlibaec_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/incude \
                           -DZLIB_INCLUDE_DIR=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/include \
                           -DZLIB_LIBRARY_RELEASE=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/lib/libz.so \
                           -DSZIP_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -DSZIP_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/include \
                           -DCMAKE_BUILD_TYPE=Release \
                           -DCMAKE_INSTALL_PREFIX=/opt/software/${NAME}/${EPOCH}/${VERSION}-${COMPILER}-${MPI}

cmake --build build-${COMPILER} -j 48
cmake --install build-${COMPILER}


# GNU GCC / OpenMPI
COMPILER="gcc"
MPI="openmpi"

module purge
module load openmpi/4/gcc/latest
module load ${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}
module load ${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}

cmake -B build-${COMPILER} -DCMAKE_C_COMPILER=mpicc -DCMAKE_CXX_COMPILER=mpicxx -DCMAKE_Fortran_COMPILER=mpifort \
                           -DCMAKE_VERBOSE_MAKEFILE=OFF \
                           -DBUILD_TESTING=OFF \
                           -DCMAKE_C_FLAGS="-mtune=native -mavx2 -mfma -fPIC" \
                           -DCMAKE_CXX_FLAGS="-mtune=native -mavx2 -mfma -fPIC" \
                           -DCMAKE_Fortran_FLAGS="-mtune=native -mavx2 -mfma -fPIC" \
                           -DHDF5_ENABLE_PARALLEL=YES \
                           -DLARGE_PARALLEL_IO=YES \
                           -DHDF5_ENABLE_SZIP_SUPPORT=ON \
                           -DHDF5_ENABLE_SZIP_ENCODING=ON \
                           -DHDF5_ENABLE_Z_LIB_SUPPORT=ON \
                           -DUSE_LIBAEC=ON \
                           -Dlibaec_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -Dlibaec_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/incude \
                           -DZLIB_INCLUDE_DIR=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/include \
                           -DZLIB_LIBRARY_RELEASE=/opt/software/${ZLIB_MODULE_NAME}/${ZLIB_MAJOR_VERSION}/${ZLIB_VERSION}-${COMPILER}/lib/libz.so \
                           -DSZIP_LIBRARY=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/lib64/libsz.so \
                           -DSZIP_INCLUDE_DIR=/opt/software/${LIBAEC_MODULE_NAME}/${LIBAEC_MAJOR_VERSION}/${LIBAEC_VERSION}-${COMPILER}/include \
                           -DCMAKE_BUILD_TYPE=Release \
                           -DCMAKE_INSTALL_PREFIX=/opt/software/${NAME}/${EPOCH}/${VERSION}-${COMPILER}-${MPI}

cmake --build build-${COMPILER} -j 48
cmake --install build-${COMPILER}

cd ${BUILD_ROOT}

rm -fr ${NAME}${EPOCH}-${NAME}${EPOCH}-${TAR_VERSION_STRING}

